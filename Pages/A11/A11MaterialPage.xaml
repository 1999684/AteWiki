<Page x:Class="AtelierWiki.Pages.A11.A11MaterialPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      
      xmlns:vm="clr-namespace:AtelierWiki.ViewModels"
      xmlns:converters="clr-namespace:AtelierWiki.Converters"
      xmlns:components="clr-namespace:AtelierWiki.Components" 
      
      mc:Ignorable="d" 
      d:DesignHeight="800" d:DesignWidth="1000"
      Title="A11 Material"
      Background="Transparent">

    <Page.Resources>
        <!-- 基础色板 -->
        <SolidColorBrush x:Key="TechBgBrush" Color="Transparent"/>
        <SolidColorBrush x:Key="TechPanelBrush" Color="#1E293B"/>
        <SolidColorBrush x:Key="TechAccentBrush" Color="#00F0FF"/>
        <SolidColorBrush x:Key="TechTextBrush" Color="#E2E8F0"/>
        <SolidColorBrush x:Key="TechDimTextBrush" Color="#94A3B8"/>

        <!-- 科技感细滚动条样式 -->
        <Style x:Key="TechScrollBarStyle" TargetType="{x:Type ScrollBar}">
            <Setter Property="Stylus.IsFlicksEnabled" Value="False"/>
            <Setter Property="Foreground" Value="{StaticResource TechPanelBrush}"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Width" Value="8"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ScrollBar}">
                        <Grid x:Name="GridRoot" Width="{TemplateBinding Width}" Background="{TemplateBinding Background}">
                            <Track x:Name="PART_Track" IsDirectionReversed="true" Focusable="false">
                                <Track.Thumb>
                                    <Thumb x:Name="Thumb">
                                        <Thumb.Template>
                                            <ControlTemplate TargetType="{x:Type Thumb}">
                                                <Border x:Name="ThumbBorder" Background="#3300F0FF" CornerRadius="4" Margin="1,0"/>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="ThumbBorder" Property="Background" Value="{StaticResource TechAccentBrush}"/>
                                                        <Setter TargetName="ThumbBorder" Property="Effect">
                                                            <Setter.Value>
                                                                <DropShadowEffect Color="#00F0FF" BlurRadius="6" ShadowDepth="0"/>
                                                            </Setter.Value>
                                                        </Setter>
                                                    </Trigger>
                                                    <Trigger Property="IsDragging" Value="True">
                                                        <Setter TargetName="ThumbBorder" Property="Background" Value="#CC00F0FF"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Thumb.Template>
                                    </Thumb>
                                </Track.Thumb>
                            </Track>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- 转换器定义 -->
        <converters:RelativePathConverter x:Key="PathConverter"/>
        <converters:BoolToVisibilityConverter x:Key="BoolToVis"/>
        <converters:NullToVisibilityConverter x:Key="NullToVis"/>

        <!-- 卡片基础样式 -->
        <Style x:Key="TechCardStyle" TargetType="Border">
            <Setter Property="Background" Value="#10FFFFFF"/>
            <Setter Property="BorderBrush" Value="#33475D6F"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect BlurRadius="5" Color="Black" Opacity="0.3" ShadowDepth="2"/>
                </Setter.Value>
            </Setter>
            <Setter Property="RenderTransformOrigin" Value="0.5,0.5"/>
            <Setter Property="RenderTransform">
                <Setter.Value>
                    <ScaleTransform ScaleX="1" ScaleY="1"/>
                </Setter.Value>
            </Setter>

            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource TechAccentBrush}"/>
                    <Setter Property="Background" Value="#2000F0FF"/>
                    <Setter Property="Effect">
                        <Setter.Value>
                            <DropShadowEffect BlurRadius="15" Color="#00F0FF" Opacity="0.4" ShadowDepth="0"/>
                        </Setter.Value>
                    </Setter>
                    <Trigger.EnterActions>
                        <BeginStoryboard>
                            <Storyboard>
                                <DoubleAnimation Storyboard.TargetProperty="RenderTransform.ScaleX" To="1.02" Duration="0:0:0.1"/>
                                <DoubleAnimation Storyboard.TargetProperty="RenderTransform.ScaleY" To="1.02" Duration="0:0:0.1"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </Trigger.EnterActions>
                    <Trigger.ExitActions>
                        <BeginStoryboard>
                            <Storyboard>
                                <DoubleAnimation Storyboard.TargetProperty="RenderTransform.ScaleX" To="1" Duration="0:0:0.1"/>
                                <DoubleAnimation Storyboard.TargetProperty="RenderTransform.ScaleY" To="1" Duration="0:0:0.1"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </Trigger.ExitActions>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- 1. 普通素材卡片模板 (修改了背景装饰部分) -->
        <DataTemplate x:Key="NormalCardTemplate">
            <Grid Margin="10">
                <Border Width="160" Height="200" Style="{StaticResource TechCardStyle}" Cursor="Hand">
                    <Border.InputBindings>
                        <MouseBinding MouseAction="LeftClick" 
                                      Command="{Binding DataContext.ShowDetailCommand, RelativeSource={RelativeSource AncestorType=Page}}" 
                                      CommandParameter="{Binding}"/>
                    </Border.InputBindings>

                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <Grid Grid.Row="0" ClipToBounds="True" Margin="2">

                            <!-- 情况A：如果有图片，显示图片 (ConverterParameter=Reverse) -->
                            <!-- 稍微旋转一点增加设计感，透明度设低一点作为背景 -->
                            <Image Source="{Binding BgImagePath, Converter={StaticResource PathConverter}}" 
       Stretch="UniformToFill" 
       Opacity="0.8"
       RenderTransformOrigin="0.5,0.5"
       Visibility="{Binding BgImagePath, Converter={StaticResource NullToVis}, ConverterParameter=Reverse}">
                                <Image.RenderTransform>
                                    <RotateTransform Angle="5"/>
                                </Image.RenderTransform>
                            </Image>

                            <!-- 情况B：如果没有图片，显示文字 (Converter 默认模式) -->
                            <TextBlock Text="{Binding Name}" FontSize="36" FontWeight="Bold" Foreground="#1FFFFFFF"
                                       HorizontalAlignment="Center" VerticalAlignment="Center"
                                       TextWrapping="Wrap" TextAlignment="Center"
                                       RenderTransformOrigin="0.5,0.5"
                                       Visibility="{Binding BgImagePath, Converter={StaticResource NullToVis}}">
                                <TextBlock.RenderTransform>
                                    <RotateTransform Angle="-15"/>
                                </TextBlock.RenderTransform>
                            </TextBlock>
                        </Grid>

                        <!-- 底部信息面板 -->
                        <Border Grid.Row="1" Background="#CC0F172A" BorderBrush="{StaticResource TechAccentBrush}" BorderThickness="0,1,0,0" 
                                CornerRadius="0,0,4,4" Padding="12,10">
                            <StackPanel>
                                <TextBlock Text="{Binding Name}" FontWeight="Bold" FontSize="14" Foreground="{StaticResource TechTextBrush}" TextWrapping="Wrap"/>
                                <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                    <TextBlock Text="LV." Foreground="{StaticResource TechAccentBrush}" FontSize="10" VerticalAlignment="Bottom" Margin="0,0,2,1"/>
                                    <TextBlock Text="{Binding Level}" Foreground="{StaticResource TechDimTextBrush}" FontSize="12" FontWeight="SemiBold"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>

                        <!-- 删除按钮 (只在编辑模式显示) -->
                        <Button HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="5"
        Content="del" Background="#00F0FF" Foreground="#333333" FontWeight="Bold"
        FontSize="14" Width="48" Height="30" Padding="4,0" BorderThickness="0" Cursor="Hand"
        Command="{Binding DataContext.DeleteItemCommand, RelativeSource={RelativeSource AncestorType=Page}}"
        CommandParameter="{Binding}"
        Visibility="{Binding DataContext.IsEditMode, RelativeSource={RelativeSource AncestorType=Page}, Converter={StaticResource BoolToVis}}">
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Border Background="{TemplateBinding Background}" CornerRadius="6">
                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Border>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>
                    </Grid>
                </Border>
            </Grid>
        </DataTemplate>

        <!-- 2. 加号卡片模板 -->
        <DataTemplate x:Key="AddCardTemplate">
            <Grid Margin="10">
                <Border Width="160" Height="200" CornerRadius="4" Background="#08FFFFFF" 
                        BorderBrush="#445566" BorderThickness="1" Cursor="Hand">
                    <Border.Style>
                        <Style TargetType="Border">
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#1500F0FF"/>
                                    <Setter Property="BorderBrush" Value="{StaticResource TechAccentBrush}"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>

                    <Border.InputBindings>
                        <MouseBinding MouseAction="LeftClick" 
                                      Command="{Binding DataContext.AddNewCommand, RelativeSource={RelativeSource AncestorType=Page}}"/>
                    </Border.InputBindings>

                    <TextBlock Text="+" FontSize="60" Foreground="#445566" 
                               HorizontalAlignment="Center" VerticalAlignment="Center"/>
                </Border>
            </Grid>
        </DataTemplate>

        <components:MaterialTemplateSelector x:Key="MyTemplateSelector"
                                             NormalTemplate="{StaticResource NormalCardTemplate}"
                                             AddTemplate="{StaticResource AddCardTemplate}"/>
    </Page.Resources>

    <Grid Background="{StaticResource TechBgBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="80"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 顶部操作栏 -->
        <Border Grid.Row="0" BorderBrush="#33475D6F" BorderThickness="0,0,0,1" Background="#05FFFFFF">
            <Grid Margin="30,0">
                <!-- 左侧：搜索 -->
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" VerticalAlignment="Center">
                    <!-- 搜索图标 -->
                    <Image Source="/Assets/Icon/search.png" 
                   Width="18" Height="18" 
                   Margin="0,0,12,0" 
                   VerticalAlignment="Center"
                   RenderOptions.BitmapScalingMode="HighQuality"/>

                    <!-- 搜索输入框 -->
                    <Border BorderBrush="#33475D6F" BorderThickness="1" CornerRadius="2" Padding="5" Width="250" Background="#0B0E14">
                        <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" 
                         BorderThickness="0" Background="Transparent" 
                         Foreground="White" CaretBrush="{StaticResource TechAccentBrush}"
                         VerticalContentAlignment="Center" FontSize="14"/>
                    </Border>
                </StackPanel>

                <!-- 右侧：编辑开关 -->
                <Button Command="{Binding ToggleEditCommand}" HorizontalAlignment="Right" VerticalAlignment="Center"
                Background="Transparent" BorderThickness="0" Cursor="Hand">
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">

                        <!-- 编辑图标 (带状态切换效果) -->
                        <Image Source="/Assets/Icon/edit.png" 
                       Width="20" Height="20" 
                       Margin="0,0,10,0" 
                       VerticalAlignment="Center"
                       RenderOptions.BitmapScalingMode="HighQuality">
                            <Image.Style>
                                <Style TargetType="Image">
                                    <!-- 默认未激活：半透明(看起来像灰色) -->
                                    <Setter Property="Opacity" Value="0.5"/>
                                    <Style.Triggers>
                                        <!-- 鼠标悬停：稍微亮一点 -->
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Opacity" Value="0.8"/>
                                        </Trigger>
                                        <!-- 编辑模式开启：全亮 + 发光 -->
                                        <DataTrigger Binding="{Binding IsEditMode}" Value="True">
                                            <Setter Property="Opacity" Value="1.0"/>
                                            <Setter Property="Effect">
                                                <Setter.Value>
                                                    <DropShadowEffect Color="#00F0FF" BlurRadius="10" ShadowDepth="0" Opacity="0.8"/>
                                                </Setter.Value>
                                            </Setter>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Image.Style>
                        </Image>

                        <!-- 状态指示灯 (保留作为辅助提示) -->
                        <Border Width="8" Height="8" CornerRadius="4" BorderBrush="#555" BorderThickness="1">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="Background" Value="Transparent"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsEditMode}" Value="True">
                                            <Setter Property="Background" Value="{StaticResource TechAccentBrush}"/>
                                            <Setter Property="BorderBrush" Value="{StaticResource TechAccentBrush}"/>
                                            <Setter Property="Effect">
                                                <Setter.Value>
                                                    <DropShadowEffect Color="#00F0FF" BlurRadius="6" ShadowDepth="0"/>
                                                </Setter.Value>
                                            </Setter>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                        </Border>
                    </StackPanel>
                </Button>
            </Grid>
        </Border>

        <!-- 内容区域 -->
        <ScrollViewer Grid.Row="1" Padding="20">
            <ScrollViewer.Resources>
                <Style TargetType="{x:Type ScrollBar}" BasedOn="{StaticResource TechScrollBarStyle}"/>
            </ScrollViewer.Resources>

            <ItemsControl ItemsSource="{Binding DisplayList}" ItemTemplateSelector="{StaticResource MyTemplateSelector}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
            </ItemsControl>
        </ScrollViewer>
    </Grid>
</Page>
